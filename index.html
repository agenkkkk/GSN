<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>WebGIS SHP GitHub</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body { margin:0; }
#map { height:100vh; }

.panel {
    position:absolute;
    top:10px;
    left:10px;
    z-index:1000;
    background:white;
    padding:15px;
    border-radius:10px;
    box-shadow:0 0 15px rgba(0,0,0,0.3);
    width:320px;
    font-family:Arial;
    max-height:90vh;
    overflow:auto;
}

.panel button {
    margin-left:3px;
    margin-top:3px;
    cursor:pointer;
}

.loading {
    color:red;
    font-size:12px;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel">
    <b>Upload SHP (.zip)</b><br><br>
    <input type="file" id="uploadFile" accept=".zip"><br><br>

    <div class="loading" id="loadingText"></div>

    <b>File GitHub:</b>
    <ul id="fileList"></ul>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>

<script>

// ================= MAP =================

var map = L.map('map').setView([-7.77,110.377],13);

L.tileLayer(
'https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
{ maxZoom:20, subdomains:['mt0','mt1','mt2','mt3'] }
).addTo(map);

// simpan layer berdasarkan nama file
var layerStore = {};

// ================= ADD LAYER =================

function addLayer(data, filename){

    var layer = L.geoJSON(data,{
        style:{ 
            color:"#"+Math.floor(Math.random()*16777215).toString(16),
            weight:2 
        },
        onEachFeature:function(feature,layer){
            if(feature.properties){
                let popup="";
                for(let key in feature.properties){
                    popup += "<b>"+key+"</b>: "+feature.properties[key]+"<br>";
                }
                layer.bindPopup(popup);
            }
        }
    }).addTo(map);

    layerStore[filename] = layer;
}

// ================= LOAD FILES =================

function loadFiles(){

    fetch("/files")
    .then(res => res.json())
    .then(files => {

        var list = document.getElementById("fileList");
        list.innerHTML = "";

        // hapus layer lama
        for(let key in layerStore){
            map.removeLayer(layerStore[key]);
        }
        layerStore = {};

        if(!files || files.length === 0){
            list.innerHTML = "<li>Tidak ada file</li>";
            return;
        }

        files.forEach(file => {

            if(!file.name.endsWith(".zip")) return;

            // ================= LIST ITEM =================
            var li = document.createElement("li");

            li.innerHTML = `
                <b>${file.name}</b><br>
                <button onclick="zoomLayer('${file.name}')">Zoom</button>
                <button onclick="downloadFile('${file.download_url}')">Download</button>
                <button onclick="deleteFile('${file.name}')">Delete</button>
                <hr>
            `;

            list.appendChild(li);

            // ================= AUTO LOAD =================
            shp(file.download_url)
            .then(data => addLayer(data, file.name))
            .catch(err => console.error("Error shp:", err));

        });

    })
    .catch(err=>{
        console.error("Gagal ambil file:", err);
    });
}

// ================= ZOOM =================

function zoomLayer(name){
    if(layerStore[name]){
        map.fitBounds(layerStore[name].getBounds());
    }
}

// ================= DOWNLOAD =================

function downloadFile(url){
    window.open(url, "_blank");
}

// ================= DELETE =================

function deleteFile(name){

    if(!confirm("Hapus file ini?")) return;

    fetch("/delete/" + name, { method:"DELETE" })
    .then(res => res.json())
    .then(() => {
        alert("File dihapus");
        loadFiles();
    })
    .catch(err => console.error(err));
}

// ================= UPLOAD =================

document.getElementById("uploadFile")
.addEventListener("change", function(e){

    var file = e.target.files[0];
    if(!file) return;

    document.getElementById("loadingText").innerText = "Uploading...";

    var formData = new FormData();
    formData.append("file", file);

    fetch("/upload", {
        method: "POST",
        body: formData
    })
    .then(res => res.json())
    .then(() => {
        document.getElementById("loadingText").innerText = "";
        loadFiles();
    })
    .catch(err=>{
        document.getElementById("loadingText").innerText = "";
        console.error(err);
    });

});

// ================= INIT =================

loadFiles();

</script>

</body>
</html>
