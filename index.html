<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>GSN WebGIS</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { margin:0; font-family:Arial; display:flex; }
#sidebar {
    width:300px;
    height:100vh;
    overflow:auto;
    background:#111;
    color:white;
    padding:15px;
}
#map { flex:1; height:100vh; }

.folder { margin-top:10px; }
.year { margin-left:20px; margin-top:5px; }
label { cursor:pointer; }
button {
    background:none;
    border:none;
    color:white;
    font-weight:bold;
    cursor:pointer;
}
</style>
</head>

<body>

<div id="sidebar">
<h3>DATA GSN</h3>
<div id="folderList">Loading...</div>
</div>

<div id="map"></div>

<script>

const username = "agenkkkk";
const repo = "GSN";
const branch = "main";
const baseAPI = `https://api.github.com/repos/${username}/${repo}/contents/files`;

const map = L.map('map').setView([-2.5, 118], 5);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'© OpenStreetMap'
}).addTo(map);

let layers = {};

async function loadFolders() {
    const res = await fetch(baseAPI);
    const folders = await res.json();
    const container = document.getElementById("folderList");
    container.innerHTML = "";

    folders.forEach(folder => {
        if(folder.type !== "dir") return;

        const div = document.createElement("div");
        div.className = "folder";

        const btn = document.createElement("button");
        btn.textContent = "▼ " + folder.name;
        btn.onclick = () => yearDiv.style.display =
            yearDiv.style.display === "none" ? "block" : "none";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.onchange = () => toggleCategory(folder.name, checkbox.checked);

        div.appendChild(checkbox);
        div.appendChild(btn);

        const yearDiv = document.createElement("div");
        yearDiv.style.display = "none";

        loadYears(folder.name, yearDiv);

        div.appendChild(yearDiv);
        container.appendChild(div);
    });
}

async function loadYears(folderName, container) {
    const res = await fetch(`${baseAPI}/${encodeURIComponent(folderName)}`);
    const years = await res.json();

    years.forEach(year => {
        if(year.type !== "dir") return;

        const div = document.createElement("div");
        div.className = "year";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.onchange = () =>
            toggleYear(folderName, year.name, checkbox.checked);

        const label = document.createElement("label");
        label.textContent = " " + year.name;

        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
    });
}

async function toggleYear(folder, year, status) {

    const key = folder + "_" + year;

    if(status) {

        const res = await fetch(`${baseAPI}/${encodeURIComponent(folder)}/${year}`);
        const items = await res.json();

        layers[key] = L.layerGroup().addTo(map);

        items.forEach(item => {
            if(item.name.endsWith(".zip")) {

                // contoh marker dummy (karena SHP belum dibaca)
                const lat = -7 + Math.random()*10;
                const lng = 110 + Math.random()*10;

                const marker = L.marker([lat,lng])
                    .bindPopup(`
                        <b>${folder}</b><br>
                        Tahun: ${year}<br>
                        <a href="${item.download_url}" target="_blank">
                        Download ZIP
                        </a>
                    `);

                layers[key].addLayer(marker);
            }
        });

    } else {
        if(layers[key]) {
            map.removeLayer(layers[key]);
        }
    }
}

function toggleCategory(folder, status) {

    const yearCheckboxes = document.querySelectorAll(".year input");

    yearCheckboxes.forEach(cb => {
        if(cb.parentElement.textContent.includes(folder)) {
            cb.checked = status;
            cb.dispatchEvent(new Event("change"));
        }
    });
}

loadFolders();

</script>
</body>
</html>
