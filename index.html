<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>GSN WebGIS System</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
<script src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js"></script>

<style>
body { margin:0; font-family:Arial; }
#map { position:absolute; top:0; left:0; width:75%; height:100%; }
#sidebar {
position:absolute;
right:0;
top:0;
width:25%;
height:100%;
background:#f4f4f4;
overflow:auto;
padding:15px;
transition:0.3s;
}
#toggleSidebar{
position:absolute;
top:10px;
right:26%;
background:white;
padding:6px 10px;
cursor:pointer;
border-radius:6px;
z-index:999;
}
.layer-item{
display:flex;
align-items:center;
margin-left:15px;
margin-bottom:5px;
}
.layer-item input{
margin-right:6px;
}
.year{
margin-left:10px;
cursor:pointer;
font-weight:bold;
}
.location{
margin-left:20px;
}
.gallery img{
width:100%;
margin-bottom:5px;
border-radius:6px;
}
.loading{
position:absolute;
top:10px;
left:50%;
transform:translateX(-50%);
background:black;
color:white;
padding:6px 12px;
border-radius:6px;
display:none;
z-index:999;
}
</style>
</head>
<body>

<div id="map"></div>
<div class="loading" id="loading">Loading...</div>
<div id="toggleSidebar">â˜°</div>

<div id="sidebar">
<h2>GSN DATA</h2>

<input type="text" id="search" placeholder="Cari file / daerah..." style="width:100%;padding:5px;margin-bottom:10px;">

<input type="file" id="uploadZip" accept=".zip,.kmz" style="margin-bottom:10px;">

<select id="basemapSelect" style="width:100%;margin-bottom:10px;">
<option value="osm">OpenStreetMap</option>
<option value="satellite">Satellite</option>
</select>

<hr>
<div id="layers"></div>
</div>

<script>

const repo="agenkkkk/GSN";
const branch="main";
const apiRoot=`https://api.github.com/repos/${repo}/contents/files?ref=${branch}`;

const map=L.map('map').setView([-2,118],5);

const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const satellite=L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png');

document.getElementById("basemapSelect").onchange=function(){
map.eachLayer(l=>map.removeLayer(l));
if(this.value==="osm") osm.addTo(map);
if(this.value==="satellite") satellite.addTo(map);
};

let activeLayers={};

function showLoading(x){
document.getElementById("loading").style.display=x?"block":"none";
}

async function fetchJSON(url){
const res=await fetch(url);
return await res.json();
}

async function loadRepo(){

showLoading(true);

const categories=await fetchJSON(apiRoot);

for(let cat of categories){

if(cat.type!=="dir") continue;

let catContainer=document.createElement("div");
catContainer.style.marginBottom="10px";

let catHeader=document.createElement("div");
catHeader.style.display="flex";
catHeader.style.alignItems="center";

let catCheck=document.createElement("input");
catCheck.type="checkbox";
catCheck.style.marginRight="6px";

let catTitle=document.createElement("b");
catTitle.innerText=cat.name;
catTitle.style.cursor="pointer";

catHeader.appendChild(catCheck);
catHeader.appendChild(catTitle);
catContainer.appendChild(catHeader);

document.getElementById("layers").appendChild(catContainer);

let yearContainer=document.createElement("div");
yearContainer.style.display="none";
yearContainer.style.marginLeft="20px";
catContainer.appendChild(yearContainer);

catTitle.onclick=function(){
yearContainer.style.display=
yearContainer.style.display==="none"?"block":"none";
};

const years=await fetchJSON(cat.url);

for(let year of years){

if(year.type!=="dir") continue;

let yearDiv=document.createElement("div");
yearDiv.style.display="flex";
yearDiv.style.alignItems="center";
yearDiv.style.marginBottom="5px";

let yearCheck=document.createElement("input");
yearCheck.type="checkbox";
yearCheck.style.marginRight="6px";

let yearLabel=document.createElement("span");
yearLabel.innerText=year.name;

yearDiv.appendChild(yearCheck);
yearDiv.appendChild(yearLabel);
yearContainer.appendChild(yearDiv);

yearCheck.onchange=async function(){

showLoading(true);

if(this.checked){

const locations=await fetchJSON(year.url);

for(let loc of locations){

if(loc.type!=="dir") continue;

const files=await fetchJSON(loc.url);

let zip=null;
for(let f of files){
if(f.name.endsWith(".zip")) zip=f.download_url;
}

if(zip){

await shp(zip).then(g=>{
let layer=L.geoJSON(g).addTo(map);
activeLayers[loc.path]=layer;
});
}
}

fitAllLayers();
}

else{

for(let key in activeLayers){
if(key.includes(year.path)){
map.removeLayer(activeLayers[key]);
delete activeLayers[key];
}
}
}

showLoading(false);
};

catCheck.onchange=function(){

yearCheck.checked=this.checked;
yearCheck.dispatchEvent(new Event('change'));

};
}
}

showLoading(false);
}

function fitAllLayers(){
let layers=Object.values(activeLayers);
if(layers.length>0){
let group=L.featureGroup(layers);
map.fitBounds(group.getBounds());
}
}

loadRepo();

</script>

</body>
</html>

