<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>GSN WebGIS</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>

<style>
body { margin:0; font-family:Arial, sans-serif; }
#map { position:absolute; left:0; top:0; width:75%; height:100%; }
#sidebar {
position:absolute;
right:0;
top:0;
width:25%;
height:100%;
background:#f5f5f5;
overflow:auto;
padding:15px;
box-shadow:-2px 0 5px rgba(0,0,0,0.1);
}
.layer-group { margin-bottom:10px; }
.year-item { margin-left:20px; margin-top:4px; }
.loading {
position:absolute;
top:10px;
left:50%;
transform:translateX(-50%);
background:black;
color:white;
padding:6px 12px;
border-radius:6px;
display:none;
z-index:999;
}
</style>
</head>
<body>

<div id="map"></div>
<div class="loading" id="loading">Loading...</div>

<div id="sidebar">
<h2>GSN DATA</h2>

<select id="basemapSelect" style="width:100%; margin-bottom:15px;">
<option value="osm">OpenStreetMap</option>
<option value="sat">Satellite</option>
</select>

<hr>
<div id="layers"></div>

</div>

<script>

const repo = "agenkkkk/GSN";
const branch = "main";
const apiRoot = `https://api.github.com/repos/${repo}/contents/files?ref=${branch}`;

const map = L.map('map').setView([-2,118],5);

const osm = L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
).addTo(map);

const satellite = L.tileLayer(
'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
);

document.getElementById("basemapSelect").onchange = function(){
map.eachLayer(l=>map.removeLayer(l));
if(this.value==="osm") osm.addTo(map);
if(this.value==="sat") satellite.addTo(map);
};

let activeLayers = {};

function showLoading(x){
document.getElementById("loading").style.display = x ? "block" : "none";
}

async function fetchJSON(url){
const res = await fetch(url);
return await res.json();
}

function fitAll(){
let layers = Object.values(activeLayers);
if(layers.length>0){
let group = L.featureGroup(layers);
map.fitBounds(group.getBounds());
}
}

async function loadRepo(){

showLoading(true);

const categories = await fetchJSON(apiRoot);

for(let cat of categories){

if(cat.type!=="dir") continue;

let groupDiv = document.createElement("div");
groupDiv.className="layer-group";

let catCheck = document.createElement("input");
catCheck.type="checkbox";

let catLabel = document.createElement("b");
catLabel.innerText=" "+cat.name;

groupDiv.appendChild(catCheck);
groupDiv.appendChild(catLabel);

document.getElementById("layers").appendChild(groupDiv);

const years = await fetchJSON(cat.url);

for(let year of years){

if(year.type!=="dir") continue;

let yearDiv = document.createElement("div");
yearDiv.className="year-item";

let yearCheck = document.createElement("input");
yearCheck.type="checkbox";

let yearLabel = document.createElement("span");
yearLabel.innerText=" "+year.name;

yearDiv.appendChild(yearCheck);
yearDiv.appendChild(yearLabel);
groupDiv.appendChild(yearDiv);

yearCheck.onchange = async function(){

showLoading(true);

if(this.checked){

const locations = await fetchJSON(year.url);

for(let loc of locations){

if(loc.type!=="dir") continue;

const files = await fetchJSON(loc.url);

let zip = null;

for(let f of files){
if(f.name.endsWith(".zip")) zip = f.download_url;
}

if(zip){

await shp(zip).then(g=>{
let layer = L.geoJSON(g).addTo(map);
activeLayers[loc.path]=layer;
});

}
}

fitAll();

}else{

for(let key in activeLayers){
if(key.includes(year.path)){
map.removeLayer(activeLayers[key]);
delete activeLayers[key];
}
}
}

showLoading(false);
};

catCheck.onchange = function(){
yearCheck.checked = this.checked;
yearCheck.dispatchEvent(new Event("change"));
};

}
}

showLoading(false);
}

loadRepo();

</script>

</body>
</html>
