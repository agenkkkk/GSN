<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>GSN WebGIS System</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
<script src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js"></script>

<style>
body { margin:0; font-family:Arial; }
#map { position:absolute; top:0; left:0; width:75%; height:100%; }
#sidebar {
position:absolute;
right:0;
top:0;
width:25%;
height:100%;
background:#f4f4f4;
overflow:auto;
padding:15px;
}
.layer-item {
display:flex;
align-items:center;
margin-bottom:8px;
}
.layer-item input {
margin-right:8px;
}
.gallery img {
width:100%;
margin-bottom:5px;
border-radius:6px;
}
.loading {
position:absolute;
top:10px;
left:50%;
transform:translateX(-50%);
background:black;
color:white;
padding:6px 12px;
border-radius:6px;
display:none;
}
</style>
</head>
<body>

<div id="map"></div>
<div class="loading" id="loading">Loading...</div>

<div id="sidebar">
<h2>GSN DATA</h2>
<input type="text" id="search" placeholder="Cari file / daerah..." style="width:100%;padding:5px;margin-bottom:10px;">
<hr>
<div id="layers"></div>
</div>

<script>

const repo = "agenkkkk/GSN";
const branch = "main";
const baseAPI = `https://api.github.com/repos/${repo}/contents/files?ref=${branch}`;

const map = L.map('map').setView([-6.5, 107], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; OpenStreetMap'
}).addTo(map);

let layerStore = {};

function showLoading(state){
document.getElementById("loading").style.display = state ? "block":"none";
}

async function fetchJSON(url){
const res = await fetch(url);
return await res.json();
}

async function loadRepository(){
showLoading(true);
const categories = await fetchJSON(baseAPI);

for (let cat of categories){

if(cat.type !== "dir") continue;

const catDiv = document.createElement("div");
catDiv.innerHTML = `<h3>${cat.name}</h3>`;
document.getElementById("layers").appendChild(catDiv);

const years = await fetchJSON(cat.url);

for (let year of years){

if(year.type !== "dir") continue;

const locations = await fetchJSON(year.url);

for (let loc of locations){

if(loc.type !== "dir") continue;

createLayerItem(cat.name, year.name, loc);
}
}
}
showLoading(false);
}

async function createLayerItem(category, year, loc){

const container = document.createElement("div");
container.className = "layer-item";

const checkbox = document.createElement("input");
checkbox.type = "checkbox";

const label = document.createElement("label");
label.innerText = `${loc.name} (${year})`;

container.appendChild(checkbox);
container.appendChild(label);
document.getElementById("layers").appendChild(container);

let layer;

checkbox.onchange = async function(){

if(this.checked){

showLoading(true);

const contents = await fetchJSON(loc.url);

let zipURL = null;
let txtURL = null;
let images = [];

for(let file of contents){

if(file.name.endsWith(".zip")) zipURL = file.download_url;
if(file.name.endsWith(".txt")) txtURL = file.download_url;
if(file.name.match(/\.(jpg|jpeg|png)$/i)) images.push(file.download_url);
}

let popupContent = `<b>${loc.name}</b><br><b>Kategori:</b> ${category}<br><b>Tahun:</b> ${year}<br><hr>`;

if(txtURL){
const txt = await fetch(txtURL);
popupContent += `<pre>${await txt.text()}</pre><hr>`;
}

if(images.length>0){
popupContent += `<div class="gallery">`;
for(let img of images){
popupContent += `<img src="${img}">`;
}
popupContent += `</div>`;
}

if(zipURL){
popupContent += `<br><a href="${zipURL}" target="_blank">Download ZIP</a>`;
}

if(zipURL){

shp(zipURL).then(function(geojson){

layer = L.geoJSON(geojson,{
onEachFeature: function(feature, layer){
layer.bindPopup(popupContent);
}
}).addTo(map);

map.fitBounds(layer.getBounds());
layerStore[loc.path] = layer;
showLoading(false);

});

}

}

else{

map.removeLayer(layerStore[loc.path]);
}
}
}

document.getElementById("search").addEventListener("keyup", function(){
let filter = this.value.toLowerCase();
let items = document.querySelectorAll(".layer-item");

items.forEach(item=>{
item.style.display = item.innerText.toLowerCase().includes(filter) ? "flex":"none";
});
});

loadRepository();

</script>

</body>
</html>
