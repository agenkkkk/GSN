<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>GSN WebGIS System</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>
<script src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js"></script>

<style>
body { margin:0; font-family:Arial; }
#map { position:absolute; top:0; left:0; width:75%; height:100%; }
#sidebar {
position:absolute;
right:0;
top:0;
width:25%;
height:100%;
background:#f4f4f4;
overflow:auto;
padding:15px;
transition:0.3s;
}
#toggleSidebar{
position:absolute;
top:10px;
right:26%;
background:white;
padding:6px 10px;
cursor:pointer;
border-radius:6px;
z-index:999;
}
.layer-item{
display:flex;
align-items:center;
margin-left:15px;
margin-bottom:5px;
}
.layer-item input{
margin-right:6px;
}
.year{
margin-left:10px;
cursor:pointer;
font-weight:bold;
}
.location{
margin-left:20px;
}
.gallery img{
width:100%;
margin-bottom:5px;
border-radius:6px;
}
.loading{
position:absolute;
top:10px;
left:50%;
transform:translateX(-50%);
background:black;
color:white;
padding:6px 12px;
border-radius:6px;
display:none;
z-index:999;
}
</style>
</head>
<body>

<div id="map"></div>
<div class="loading" id="loading">Loading...</div>
<div id="toggleSidebar">☰</div>

<div id="sidebar">
<h2>GSN DATA</h2>

<input type="text" id="search" placeholder="Cari file / daerah..." style="width:100%;padding:5px;margin-bottom:10px;">

<input type="file" id="uploadZip" accept=".zip,.kmz" style="margin-bottom:10px;">

<select id="basemapSelect" style="width:100%;margin-bottom:10px;">
<option value="osm">OpenStreetMap</option>
<option value="satellite">Satellite</option>
</select>

<hr>
<div id="layers"></div>
</div>

<script>

const repo="agenkkkk/GSN";
const branch="main";
const apiRoot=`https://api.github.com/repos/${repo}/contents/files?ref=${branch}`;

const map=L.map('map').setView([-2,118],5);

const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
const satellite=L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png');

osm.addTo(map);

document.getElementById("basemapSelect").onchange=function(){
map.eachLayer(l=>map.removeLayer(l));
if(this.value==="osm") osm.addTo(map);
if(this.value==="satellite") satellite.addTo(map);
};

let activeLayers={};

function showLoading(x){
document.getElementById("loading").style.display=x?"block":"none";
}

async function fetchJSON(url){
const res=await fetch(url);
return await res.json();
}

async function loadRepo(){
showLoading(true);
const categories=await fetchJSON(apiRoot);

for(let cat of categories){
if(cat.type!=="dir") continue;

let catDiv=document.createElement("div");
catDiv.innerHTML=`<b>${cat.name}</b>`;
document.getElementById("layers").appendChild(catDiv);

const years=await fetchJSON(cat.url);

for(let year of years){
if(year.type!=="dir") continue;

let yearDiv=document.createElement("div");
yearDiv.className="year";
yearDiv.innerText="▶ "+year.name;
catDiv.appendChild(yearDiv);

let yearContainer=document.createElement("div");
yearContainer.style.display="none";
catDiv.appendChild(yearContainer);

yearDiv.onclick=function(){
yearContainer.style.display=yearContainer.style.display==="none"?"block":"none";
};

const locations=await fetchJSON(year.url);

for(let loc of locations){
if(loc.type!=="dir") continue;

let locDiv=document.createElement("div");
locDiv.className="layer-item location";

let check=document.createElement("input");
check.type="checkbox";

let label=document.createElement("label");
label.innerText=loc.name;

locDiv.appendChild(check);
locDiv.appendChild(label);
yearContainer.appendChild(locDiv);

check.onchange=async function(){

if(this.checked){
showLoading(true);

const files=await fetchJSON(loc.url);

let zip=null, txt=null, images=[];
for(let f of files){
if(f.name.endsWith(".zip")) zip=f.download_url;
if(f.name.endsWith(".txt")) txt=f.download_url;
if(f.name.match(/\.(jpg|jpeg|png)$/i)) images.push(f.download_url);
}

let popup=`<b>${loc.name}</b><hr>`;

if(txt){
const t=await fetch(txt);
popup+=`<pre>${await t.text()}</pre><hr>`;
}

for(let img of images){
popup+=`<img src="${img}" width="100%">`;
}

if(zip){
popup+=`<br><a href="${zip}" target="_blank">Download ZIP</a>`;
}

if(zip){
shp(zip).then(g=>{
let layer=L.geoJSON(g,{
onEachFeature:(f,l)=>l.bindPopup(popup)
}).addTo(map);

map.fitBounds(layer.getBounds());
activeLayers[loc.path]=layer;
showLoading(false);
});
}
}
else{
map.removeLayer(activeLayers[loc.path]);
}
};
}
}
}
showLoading(false);
}

document.getElementById("uploadZip").onchange=function(e){
let file=e.target.files[0];
if(!file) return;
showLoading(true);

shp(file).then(g=>{
let layer=L.geoJSON(g).addTo(map);
map.fitBounds(layer.getBounds());
showLoading(false);
});
};

document.getElementById("search").onkeyup=function(){
let val=this.value.toLowerCase();
document.querySelectorAll(".location").forEach(l=>{
l.style.display=l.innerText.toLowerCase().includes(val)?"flex":"none";
});
};

document.getElementById("toggleSidebar").onclick=function(){
let sb=document.getElementById("sidebar");
if(sb.style.display==="none"){
sb.style.display="block";
this.style.right="26%";
}else{
sb.style.display="none";
this.style.right="1%";
}
};

loadRepo();

</script>
</body>
</html>
