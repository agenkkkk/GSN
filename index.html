<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>WebGIS SHP GitHub</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    overflow:hidden;
}

#map{
    height:100vh;
    width:100%;
}

/* ===== SIDEBAR ===== */
#sidebar{
    position:absolute;
    top:0;
    right:0;
    width:320px;
    height:100vh;
    background:#f4f4f4;
    border-left:1px solid #ccc;
    padding:15px;
    box-sizing:border-box;
    overflow:auto;
    transform:translateX(100%);
    transition:0.3s;
    z-index:1000;
}

#sidebar.active{
    transform:translateX(0);
}

#toggleBtn{
    position:absolute;
    top:15px;
    right:15px;
    z-index:1100;
    background:white;
    border:none;
    padding:8px 12px;
    font-size:18px;
    cursor:pointer;
    border-radius:6px;
    box-shadow:0 2px 6px rgba(0,0,0,0.2);
}

.file-item{
    margin-bottom:15px;
    padding:10px;
    background:white;
    border-radius:6px;
    box-shadow:0 1px 4px rgba(0,0,0,0.1);
}

.file-item button{
    margin-top:5px;
    margin-right:5px;
    padding:6px 10px;
    cursor:pointer;
    border:none;
    border-radius:4px;
    background:#2c7be5;
    color:white;
}

/* ===== TOOLTIP STYLE ===== */
.leaflet-tooltip{
    background:white;
    color:#333;
    border-radius:6px;
    padding:4px 8px;
    font-weight:bold;
    border:1px solid #ccc;
}
</style>
</head>

<body>

<div id="map"></div>
<button id="toggleBtn">â˜°</button>

<div id="sidebar">
    <h2>Daftar File SHP</h2>
    <div id="loading">Memuat file...</div>
    <div id="fileList"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/shpjs@latest/dist/shp.min.js"></script>

<script>

// ================= CONFIG =================
const OWNER = "agenkkkk";
const REPO = "GSN";
const FOLDER = "shp";
const BRANCH = "main";
const markerImage = "./img/point-of-interest.png";

let layerStore = {};
let centerMarkers = {};
let globalBounds = null;

// ================= MAP INIT =================
const map = L.map('map',{
    minZoom:5,
    maxZoom:18
}).setView([-2.5,118],5);

// ===== BASEMAP =====
const imagery = L.tileLayer(
'https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
{ subdomains:['mt0','mt1','mt2','mt3'], maxZoom:18 }
);

const satellite = L.tileLayer(
'https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
{ subdomains:['mt0','mt1','mt2','mt3'], maxZoom:18 }
);

imagery.addTo(map);

L.control.layers(
    {
        "Imagery": imagery,
        "Satellite": satellite
    },
    null,
    { collapsed:false }
).addTo(map);

// ================= SIDEBAR TOGGLE =================
document.getElementById("toggleBtn")
.addEventListener("click",()=>{
    document.getElementById("sidebar")
    .classList.toggle("active");
});

// ================= SEARCH INPUT =================
const searchInput = document.createElement("input");
searchInput.type="text";
searchInput.placeholder="Search wilayah...";
searchInput.style.width="100%";
searchInput.style.marginBottom="10px";
document.getElementById("sidebar")
.insertBefore(searchInput,document.getElementById("loading"));

searchInput.addEventListener("keyup",function(){
    const value=this.value.toLowerCase();
    document.querySelectorAll(".file-item")
    .forEach(item=>{
        item.style.display =
        item.innerText.toLowerCase().includes(value)
        ? "block" : "none";
    });
});

// ================= UTIL =================
function stringToColor(str){
    let hash=0;
    for(let i=0;i<str.length;i++){
        hash=str.charCodeAt(i)+((hash<<5)-hash);
    }
    let color=(hash & 0x00FFFFFF)
    .toString(16).toUpperCase();
    return "#"+"000000".substring(0,6-color.length)+color;
}

function createIcon(size){
    return L.icon({
        iconUrl:markerImage,
        iconSize:[size,size],
        iconAnchor:[size/2,size]
    });
}

// ================= LOAD FILES =================
async function loadFiles(){

    const fileListDiv=document.getElementById("fileList");
    const loadingDiv=document.getElementById("loading");

    try{

        const apiUrl=
        `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FOLDER}?ref=${BRANCH}`;

        const response=await fetch(apiUrl);
        const files=await response.json();
        const shpFiles=files.filter(f=>f.name.endsWith(".zip"));

        for(const file of shpFiles){

            const name=file.name;
            const displayName=name.replace(".zip","");
            const url=file.download_url;
            const color=stringToColor(name);

            // ===== LOAD SHP =====
            const res=await fetch(url);
            const arrayBuffer=await res.arrayBuffer();
            const data=await shp(arrayBuffer);

            const layer=L.geoJSON(data,{
                style:{
                    color:color,
                    weight:2,
                    fillOpacity:0.4
                }
            });

            layerStore[name]=layer;

            // ===== CENTER MARKER =====
            const center=layer.getBounds().getCenter();
            const baseSize=40;

            const marker=L.marker(center,{
                icon:createIcon(baseSize)
            });

            marker.bindTooltip(displayName,{
                direction:"top"
            });

            marker.on("click",()=>{
                map.fitBounds(layer.getBounds());
            });

            centerMarkers[name]=marker;

            // ===== SIDEBAR LIST =====
            const div=document.createElement("div");
            div.className="file-item";
            div.innerHTML=`
                <b>${displayName}</b><br>
                <input type="checkbox" checked
                onchange="toggleLayer('${name}',this.checked)">
                ON/OFF
                <br>
                <button onclick="zoomToLayer('${name}')">Zoom</button>
                <button onclick="window.open('${url}','_blank')">Download</button>
            `;
            fileListDiv.appendChild(div);

            // DEFAULT tampil
            layer.addTo(map);
            marker.addTo(map);

            if(!globalBounds){
                globalBounds=layer.getBounds();
            }else{
                globalBounds.extend(layer.getBounds());
            }
        }

        if(globalBounds){
            map.fitBounds(globalBounds);
        }

    }catch(err){
        console.error(err);
    }finally{
        loadingDiv.style.display="none";
    }
}

// ================= TOGGLE LAYER =================
function toggleLayer(name,state){

    if(state){
        layerStore[name].addTo(map);
        centerMarkers[name].addTo(map);
    }else{
        map.removeLayer(layerStore[name]);
        map.removeLayer(centerMarkers[name]);
    }
}

// ================= ZOOM =================
function zoomToLayer(name){
    if(layerStore[name]){
        map.fitBounds(layerStore[name].getBounds());
    }
}

// ================= RESIZE MARKER SAAT ZOOM =================
map.on("zoomend",()=>{
    const zoom=map.getZoom();
    const size=Math.max(35,zoom*2);
    for(let k in centerMarkers){
        centerMarkers[k]
        .setIcon(createIcon(size));
    }
});

loadFiles();

</script>

</html>

