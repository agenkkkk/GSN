<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>GSN WebGIS</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
    margin:0;
    font-family:Arial, sans-serif;
    display:flex;
}

#sidebar {
    width:300px;
    height:100vh;
    overflow:auto;
    background:#111;
    color:white;
    padding:15px;
}

#map {
    flex:1;
    height:100vh;
}

.folder { margin-top:10px; }
.year { margin-left:20px; margin-top:5px; }

button {
    background:none;
    border:none;
    color:white;
    font-weight:bold;
    cursor:pointer;
}

input { cursor:pointer; }

</style>
</head>

<body>

<div id="sidebar">
    <h3>DATA GSN</h3>
    <div id="folderList">Loading...</div>
</div>

<div id="map"></div>

<script>

// ============================
// CONFIG
// ============================

const username = "agenkkkk";
const repo = "GSN";
const branch = "main";

const baseAPI = `https://api.github.com/repos/${username}/${repo}/contents/files`;

// ============================
// MAP
// ============================

const map = L.map('map').setView([-2.5,118],5);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'© OpenStreetMap'
}).addTo(map);

let layers = {};

// ============================
// BUILD SIDEBAR (AUTO CATEGORY)
// ============================

async function buildSidebar(){

    const container = document.getElementById("folderList");
    container.innerHTML = "Loading...";

    try {

        const res = await fetch(baseAPI);
        const categories = await res.json();

        container.innerHTML = "";

        categories.forEach(cat=>{

            if(cat.type !== "dir") return;

            const div = document.createElement("div");
            div.className = "folder";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";

            const btn = document.createElement("button");
            btn.textContent = "▼ " + cat.name;

            const yearDiv = document.createElement("div");
            yearDiv.style.display = "none";

            btn.onclick = ()=>{
                yearDiv.style.display =
                yearDiv.style.display === "none" ? "block" : "none";
            };

            // checkbox kategori → aktifkan semua tahun
            checkbox.onchange = ()=>{
                const yearChecks = yearDiv.querySelectorAll("input");
                yearChecks.forEach(cb=>{
                    cb.checked = checkbox.checked;
                    cb.dispatchEvent(new Event("change"));
                });
            };

            div.appendChild(checkbox);
            div.appendChild(btn);

            loadYears(cat.name, yearDiv);

            div.appendChild(yearDiv);
            container.appendChild(div);
        });

    } catch (err) {
        container.innerHTML = "Gagal memuat data (Rate limit GitHub)";
        console.error(err);
    }
}

// ============================
// LOAD TAHUN
// ============================

async function loadYears(category, container){

    try {

        const res = await fetch(`${baseAPI}/${encodeURIComponent(category)}`);
        const years = await res.json();

        years.forEach(year=>{

            if(year.type !== "dir") return;

            const div = document.createElement("div");
            div.className = "year";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";

            checkbox.onchange = ()=>{
                toggleYear(category, year.name, checkbox.checked);
            };

            const label = document.createElement("label");
            label.textContent = " " + year.name;

            div.appendChild(checkbox);
            div.appendChild(label);
            container.appendChild(div);
        });

    } catch (err) {
        console.error(err);
    }
}

// ============================
// TOGGLE TAHUN
// ============================

async function toggleYear(category, year, status){

    const key = category + "_" + year;

    if(status){

        const group = L.layerGroup().addTo(map);
        layers[key] = group;

        try {

            // Ambil folder project dalam tahun
            const res = await fetch(`${baseAPI}/${encodeURIComponent(category)}/${year}`);
            const projects = await res.json();

            for(const proj of projects){

                if(proj.type !== "dir") continue;

                // Ambil isi folder project
                const res2 = await fetch(proj.url);
                const files = await res2.json();

                files.forEach(file=>{

                    if(file.name.endsWith(".zip")){

                        // marker contoh (dummy)
                        const lat = -7 + Math.random()*10;
                        const lng = 110 + Math.random()*10;

                        const marker = L.marker([lat,lng])
                        .bindPopup(`
                            <b>${category}</b><br>
                            Tahun: ${year}<br>
                            <a href="${file.download_url}" target="_blank">
                            Download ZIP
                            </a>
                        `);

                        group.addLayer(marker);
                    }
                });
            }

        } catch (err) {
            console.error(err);
        }

    } else {

        if(layers[key]){
            map.removeLayer(layers[key]);
        }
    }
}

// ============================
// START
// ============================

buildSidebar();

</script>

</body>
</html>

