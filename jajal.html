<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>GSN WebGIS Final</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { margin:0; font-family:Arial, sans-serif; display:flex; }
#sidebar {
    width:300px;
    height:100vh;
    overflow:auto;
    background:#111;
    color:white;
    padding:15px;
}
#map { flex:1; height:100vh; }

.folder { margin-top:10px; }
.year { margin-left:20px; margin-top:5px; }
input { margin-right:6px; cursor:pointer; }
button {
    background:none; border:none;
    color:white; font-weight:bold;
    cursor:pointer;
}
</style>
</head>

<body>

<div id="sidebar">
    <h3>DATA GSN</h3>
    <div id="folderList">Loading...</div>
</div>

<div id="map"></div>

<script>

// =================================
// CONFIG
// =================================

const username = "agenkkkk";
const repo = "GSN";
const branch = "main";

// raw.githubusercontent URL
const rawRoot = `https://raw.githubusercontent.com/${username}/${repo}/${branch}/files`;

// =================================
// MAP
// =================================

const map = L.map('map').setView([-2.5,118],5);

const osm = L.tileLayer(
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
).addTo(map);

// =================================
// UTILS
// =================================

async function listFolderRaw(url) {
    // Fetch GitHub raw folder listing
    const res = await fetch(url);
    const text = await res.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(text,"text/html");
    const items = [];
    doc.querySelectorAll("table tr.js-navigation-item").forEach(row=>{
        const link = row.querySelector("a.js-navigation-open");
        if(link) {
            items.push(link.textContent.trim());
        }
    });
    return items;
}

// =================================
// BUILD SIDEBAR
// =================================

async function buildSidebar(){

    const container = document.getElementById("folderList");
    container.innerHTML="Loading...";

    // Get list of category folders
    const categories = await listFolderRaw(`https://github.com/${username}/${repo}/tree/${branch}/files`);

    container.innerHTML="";

    for(let catName of categories){
        if(catName.startsWith(".") || !catName) continue;

        const div = document.createElement("div");
        div.className="folder";

        const catCheck = document.createElement("input");
        catCheck.type="checkbox";

        const catBtn = document.createElement("button");
        catBtn.textContent = "â–¼ " + catName;

        const yearDiv = document.createElement("div");
        yearDiv.style.display="none";

        catBtn.onclick = ()=>{
            yearDiv.style.display = yearDiv.style.display==="none"?"block":"none";
        };

        catCheck.onchange = ()=>{
            const yc = yearDiv.querySelectorAll("input");
            yc.forEach(cb=>{
                cb.checked = catCheck.checked;
                cb.dispatchEvent(new Event("change"));
            });
        };

        div.appendChild(catCheck);
        div.appendChild(catBtn);

        // Fetch years
        const years = await listFolderRaw(`https://github.com/${username}/${repo}/tree/${branch}/files/${encodeURIComponent(catName)}`);

        years.forEach(yearName =>{

            if(yearName.startsWith(".")) return;

            const yDiv = document.createElement("div");
            yDiv.className="year";

            const yCheck = document.createElement("input");
            yCheck.type="checkbox";

            const yLabel = document.createElement("span");
            yLabel.textContent=" "+yearName;

            yCheck.onchange = ()=>{
                toggleYear(catName,yearName,yCheck.checked);
            };

            yDiv.appendChild(yCheck);
            yDiv.appendChild(yLabel);
            yearDiv.appendChild(yDiv);
        });

        div.appendChild(yearDiv);
        container.appendChild(div);
    }
}

// =================================
// LOAD YEAR CONTENT
// =================================

let activeLayers={};

async function toggleYear(category,year,status){

    const key = `${category}::${year}`;

    if(status){

        const group = L.layerGroup().addTo(map);
        activeLayers[key] = group;

        // Parse projects in year
        const projects = await listFolderRaw(
            `https://github.com/${username}/${repo}/tree/${branch}/files/${encodeURIComponent(category)}/${year}`
        );

        for(let proj of projects){

            if(proj.startsWith(".")) continue;

            // Inside project folder
            const files = await listFolderRaw(
                `https://github.com/${username}/${repo}/tree/${branch}/files/${encodeURIComponent(category)}/${year}/${encodeURIComponent(proj)}`
            );

            files.forEach(fileName =>{

                if(fileName.toLowerCase().endsWith(".zip")){

                    // temporary random marker
                    const lat = -7 + Math.random()*10;
                    const lng = 110 + Math.random()*10;

                    const marker = L.marker([lat,lng])
                    .bindPopup(`
                        <b>${category}</b><br>
                        Tahun: ${year}<br>
                        Proyek: ${proj}<br>
                        File: ${fileName}
                    `);

                    group.addLayer(marker);
                }
            });
        }
    }
    else {
        if(activeLayers[key]){
            map.removeLayer(activeLayers[key]);
        }
    }
}

// =================================
// RUN
// =================================

buildSidebar();

</script>

</body>
</html>
